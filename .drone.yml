kind: pipeline
type: docker
name: "Test Environment"

trigger:
  branch:
    - dev
  event:
    include:
      - push

steps:
- name: Build Env
  image: pfeiffermax/python-poetry:1.11.0-poetry1.8.3-python3.12.3-bookworm
  commands:
  - poetry install
  - poetry build
  - pwd
  - ls -R
  environment:
    DB_NAME:
      from_secret: db_name
    DB_USERNAME:
      from_secret: username
    DB_PASSWORD:
      from_secret: password
  
---
kind: pipeline
type: docker
name: "Server Test Stage"

trigger:
  branch:
    - main
  event:
    include:
      - push

steps:
- name: Build
  image: pfeiffermax/python-poetry:1.11.0-poetry1.8.3-python3.12.3-bookworm
  commands:
    - poetry install
    - poetry build
  environment:
    DB_NAME:
      from_secret: db_name
    DB_USERNAME:
      from_secret: username
    DB_PASSWORD:
      from_secret: password
    
- name: Sync to stage server
  image: appleboy/drone-scp
  settings:
    host: ${DEV_SERVER}
    username: ${DEV_SERVER_USER} 
    ssh_key: ${DEV_SERVER_KEY}
    target: ${DEV_SERVER_PATH}
    source: ./dist/*
    overwrite: true
  environment:
    DEV_SERVER:
      from_secret: dev-server
    DEV_SERVER_PATH:
      from_secret: dev-server-path
    DEV_SERVER_USER:
      from_secret: dev-server-user
    DEV_SERVER_KEY:
      from_secret: dev-server-key

---
kind: secret
name: dev-server
get:
  path: kv-v2/data/eucalypto/dev-stage
  name: server-address

---
kind: secret
name: dev-server-path
get:
  path: kv-v2/data/eucalypto/dev-stage
  name: target-path

---
kind: secret
name: dev-server-user
get:
  path: kv-v2/data/eucalypto/dev-stage
  name: dev-server-user

---
kind: secret
name: dev-server-key
get:
  path: kv-v2/data/eucalypto/dev-stage
  name: dev-server-key

---
kind: secret
name: db_name
get:
  path: kv-v2/data/eucalypto/db-info
  name: db_name

---
kind: secret
name: username
get:
  path: kv-v2/data/eucalypto/db-info
  name: db_username

--- 
kind: secret
name: password
get:
  path: kv-v2/data/eucalypto/db-info
  name: db_password